<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Money Monsters - Dashboard</title>
  <link rel="stylesheet" href="/style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
  <div class="homepage">
    <main class="container">
      <header>
        <%- include('../partials/header') %>
      </header>
      <section class="card-section">
        <div class="balance-section">
         <% if (user && user.balance != null) { %>
            <h2>Current Balance: $<%= user.balance.toFixed(2) %></h2>
          <% } else { %>
            <h2>Balance not available</h2>
          <% } %>

          <form action="/balance/add" method="POST" style="display: inline;">
            <input type="hidden" name="amount" value="1" />
            <button type="submit">Add $1</button>
          </form>

          <form action="/balance/remove" method="POST" style="display: inline;">
            <input type="hidden" name="amount" value="1" />
            <button type="submit">Remove $1</button>
          </form>
        </div>
        </section>
      <section class="card-section">
        <h2><a href="/goals" style="text-decoration: none; color: inherit;">Goal</a></h2>
        <% if (goals && goals.length > 0) { %>
          <% goals.forEach(function(goal) { %>
            <div class="card">
              <div class="card-left">
                <% if (goal.purchaseLink) { %>
                  <img src="/images/goal.png" alt="Goal Image" class="icon" />
                <% } else { %>
                  <div class="initials-avatar"><%= getInitials(goal.title) %></div>
                <% } %>
                <div>
                  <h3><%= goal.title %></h3>
                  <p>$<%= goal.price.toFixed(2) %></p>
                </div>
              </div>
              <div class="progress-wrapper">
                <div class="progress-bar" style="width: 80%"></div>
                <span>80%</span>
              </div>
            </div>
          <% }); %>
        <% } else { %>
          <div class="card">
            <div class="card-left">
              <img src="/images/default-goal.png" alt="Goal Image" class="icon" />
              <div>
                <h3>No goals yet</h3>
                <p>Click to add goals</p>
              </div>
            </div>
          </div>
        <% } %>
      </section>

      <section class="card-section">
        <h2><a href="/tasks" style="text-decoration: none; color: inherit;">Earn</a></h2>
        <% if (tasks && tasks.length > 0) { %>
          <% const statusOrder = { new: 0, in_progress: 1, overdue: 2, completed: 3 };
             tasks = tasks.slice().sort((a, b) => (statusOrder[a.status] ?? 99) - (statusOrder[b.status] ?? 99)); %>
          <% tasks.forEach(function(task) { %>
            <div class="card earn">
              <% 
                let iconClass = 'fa-solid ';
                switch(task.category) {
                  case 'pet': iconClass += 'fa-dog'; break;
                  case 'cleaning': iconClass += 'fa-broom'; break;
                  case 'garage': iconClass += 'fa-warehouse'; break;
                  case 'garden': iconClass += 'fa-leaf'; break;
                  case 'misc': iconClass += 'fa-circle-check'; break;
                  default: iconClass += 'fa-list-check';
                }
              %>
              <i class="<%= iconClass %> task-icon"></i>
              <div class="task-text">
                <p><%= task.title %></p>
                <small class="due-date" data-due="<%= task.dueDate && task.dueDate.toISOString ? task.dueDate.toISOString() : task.dueDate %>">$<%= task.reward ? task.reward.toFixed(2) : '0.00' %> | </small>
              </div>
              <div class="task-status">
                <span class="status-badge <%= task.status %>">
                  <%= task.status ? task.status.charAt(0).toUpperCase() + task.status.slice(1).replace('_', ' ') : 'New' %>
                </span>
              </div>
            </div>
          <% }); %>
        <% } else { %>
          <div class="card earn">
            <i class="fa-solid fa-plus"></i>
            <div>
              <p>No tasks available</p>
              <small>Click to add new tasks</small>
            </div>
          </div>
        <% } %>
      </section>

      <section class="card-section">
        <h2>Learn</h2>
        <div class="card learn">
          <p>Earning Money..</p>
          <small>Earning Basics</small>
          <div class="progress-wrapper">
            <div class="progress-bar" style="width: 50%"></div>
            <span>50%</span>
          </div>
        </div>
        <div class="card learn">
          <p>Needs vs Wants..</p>
          <small>Smart Spending</small>
          <div class="progress-wrapper">
            <div class="progress-bar" style="width: 90%"></div>
            <span>90%</span>
          </div>
        </div>
      </section>
      <%- include('../partials/bottomNav') %>
    </main>
  </div>
  <script src="/dynamic/formatDueDates.js"></script>
</body>
</html> 