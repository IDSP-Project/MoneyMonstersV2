<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Money Monsters - Dashboard</title>
  <link rel="stylesheet" href="/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
  <div class="homepage">
    <main class="container">
      <header>
        <%- include('../partials/header') %>
        <% if (locals.viewingAsChild && locals.viewingChildName) { %>
          <%- include('../partials/viewingAsChild') %>
        <% } %>
      </header>

      <section class="card-section">
        <h2><a href="/goals" style="text-decoration: none; color: inherit;">Goals</a></h2>
        <% if (goals && goals.length > 0) { %>
          <% goals.forEach(function(goal) { %>
            <div class="card">
              <div class="card-left">
                <% if (goal.imageUrl) { %>
                  <img src="<%= goal.imageUrl %>" alt="Goal Image" class="icon">
                <% } else { %>
                  <div class="initials-avatar">
                    <%= goal.title ? goal.title.charAt(0).toUpperCase() : 'G' %>
                  </div>
                <% } %>
                <div>
                  <h3><%= goal.title %></h3>
                  <p>$<%= goal.targetAmount ? goal.targetAmount.toFixed(2) : '0.00' %></p>
                </div>
              </div>
              <div class="goal-status">
                <% 
                  const progressPercent = goal.targetAmount > 0 
                    ? Math.round((goal.progress / goal.targetAmount) * 100) 
                    : 0;
                %>
                <span class="goal-progress">
                  $<%= goal.progress ? goal.progress.toFixed(2) : '0.00' %> of $<%= goal.targetAmount ? goal.targetAmount.toFixed(2) : '0.00' %>
                  (<%= progressPercent %>%)
                </span>
              </div>
            </div>
          <% }); %>
        <% } else { %>
          <div class="card">
            <div class="card-left">
              <img src="/images/default-goal.png" alt="Goal Image" class="icon">
              <div>
                <h3>No goals yet</h3>
                <p>Click to add goals</p>
              </div>
            </div>
          </div>
        <% } %>
      </section>

      <section class="card-section">
        <h2><a href="/tasks" style="text-decoration: none; color: inherit;">Earn</a></h2>
        <% if (tasks && tasks.length > 0) { %>
          <% const statusOrder = { new: 0, in_progress: 1, overdue: 2, completed: 3 };
             const sortedTasks = tasks.slice().sort((a, b) => (statusOrder[a.status] ?? 99) - (statusOrder[b.status] ?? 99)); %>
          <% sortedTasks.forEach(function(task) { %>
            <div class="card earn">
              <% 
                let iconClass = 'fa-solid ';
                switch(task.category) {
                  case 'pet': iconClass += 'fa-dog'; break;
                  case 'cleaning': iconClass += 'fa-broom'; break;
                  case 'garage': iconClass += 'fa-warehouse'; break;
                  case 'garden': iconClass += 'fa-leaf'; break;
                  case 'misc': iconClass += 'fa-circle-check'; break;
                  default: iconClass += 'fa-list-check';
                }
              %>
              <i class="<%= iconClass %> task-icon"></i>
              <div class="task-text">
                <p><%= task.title %></p>
                <small class="due-date" data-due="<%= task.dueDate && task.dueDate.toISOString ? task.dueDate.toISOString() : task.dueDate %>">
                  $<%= task.reward ? task.reward.toFixed(2) : '0.00' %> | <%= task.formattedDue || 'No due date' %>
                </small>
              </div>
              <div class="task-status">
                <span class="status-badge <%= task.status %>">
                  <%= task.status ? task.status.charAt(0).toUpperCase() + task.status.slice(1).replace('_', ' ') : 'New' %>
                </span>
              </div>
            </div>
          <% }); %>
        <% } else { %>
          <div class="card earn">
            <i class="fa-solid fa-plus"></i>
            <div>
              <p>No tasks available</p>
              <small>Click to add new tasks</small>
            </div>
          </div>
        <% } %>
      </section>

      <section class="card-section">
        <h2><a href="/learning" style="text-decoration: none; color: inherit;">Learn</a></h2>
        <% if (learningProgress && learningProgress.length > 0) { %>
          <% learningProgress.forEach(function(module) { %>
            <div class="card learn">
              <i class="fa-solid fa-book-open-reader learn-icon"></i>
              <div class="learn-content">
                <p><%= module.title %></p>
                <small><%= module.category || 'Financial Education' %></small>
              </div>
              <div class="learn-status">
                <% if (module.completed) { %>
                  <span class="status-badge completed"><i class="fa-solid fa-check"></i> Complete</span>
                <% } else { %>
                  <span class="status-badge in-progress"><%= module.percentComplete %>% Complete</span>
                <% } %>
              </div>
            </div>
          <% }); %>
        <% } else { %>
          <div class="card learn">
            <i class="fa-solid fa-book learn-icon"></i>
            <div class="learn-content">
              <p>No learning modules</p>
              <small>Check back soon!</small>
            </div>
          </div>
        <% } %>
      </section>
      
      <%- include('../partials/bottomNav') %>
    </main>
  </div>
  <script src="/dynamic/formatDueDates.js"></script>
</body>
</html>