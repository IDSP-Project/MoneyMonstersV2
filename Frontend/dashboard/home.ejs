<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Money Monsters - Dashboard</title>
  <link rel="stylesheet" href="/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
  <div class="homepage">
    <main class="container">
      <header>
        <%- include('../partials/header') %>
        <% if (locals.viewingAsChild && locals.viewingChildName) { %>
          <%- include('../partials/viewingAsChild') %>
        <% } %>
      </header>

      <section class="balance-section">
        <% if (user && user.balance != null) { %>
          <% if (user.accountType === 'parent' && !locals.viewingAsChild) { %>
            <h1>Family's savings: $<%= user.balance.toFixed(2) %></h1>
          <% } else { %>
            <h1>You have saved: $<%= user.balance.toFixed(2) %></h1>
          <% } %>
        <% } else { %>
          <h2>Balance not available</h2>
        <% } %>

        <!-- <form action="/balance/add" method="POST" style="display: inline;">
          <input type="hidden" name="amount" value="1" />
          <button type="submit" class="btn">Add $1</button>
        </form>

        <form action="/balance/remove" method="POST" style="display: inline;">
          <input type="hidden" name="amount" value="1" />
          <button type="submit" class="btn">Remove $1</button>
        </form> -->
      </section>
     <section class="response-section">
      </section>
      <section class="card-section-goals">
       <div class="goalsContainer">
        <% if (goals && goals.length > 0) { %>
          <div class="sectionTabs">
            <h2>Goals</h2>
            <h2>Progress</h2>
          </div>
          <div class="goalList">
            <% goals.forEach(function(goal) { %>
              <a href="/goals/view/<%= goal._id %>" class="goalCardLink">
                <div class="goalCard">
                  <div class="goalInfo">
                    <% if (goal.purchaseLink) { %>
                      <img src="/images/goal.png" alt="Goal Image" class="goalImage" />
                    <% } else { %>
                      <div class="initialsAvatar"><%= getInitials(goal.title) %></div>
                    <% } %>
                    <div class="goalText">
                      <h3><%= goal.title %></h3>
                      <p><%= goal.purchaseLink ? new URL(goal.purchaseLink).hostname : 'Custom Goal' %></p>
                    </div>
                  </div>
                  <div class="goalProgress">
                    <div class="progressBar">
                      <div class="progressFill" data-progress="<%= goal.progress || 0 %>" style="--progress-width: <%= goal.progress || 0 %>%"></div>
                    </div>
                    <span><%= Math.round(goal.progress || 0) %>%</span>
                  </div>
                </div>
              </a>
            <% }); %>
          </div>
        <% } else { %>
          <div class="noGoalsMessage">
            <h1>No Goals Yet</h1>
            <p>You haven't set any goals yet. Start by adding your first goal!</p>
          </div>
        <% } %>
      </div>

  

          <div class="tasksContainer">
          <% if (tasks && tasks.length > 0) { %>
            <div class="sectionTabs">
              <h2>Tasks</h2>
              <h2>Status</h2>
            </div>
            <div class="taskList">
              <% tasks.forEach(function(task) { %>
                <div class="taskCard" data-description="<%= task.description ? task.description.split('"').join('&quot;') : '' %>" data-task-id="<%= task._id %>" data-goal-id="<%= task.goalId ? task.goalId : '' %>" data-parent-name="<%= task.parentName || '' %>" data-category="<%= task.category || 'misc' %>">
                  <div class="taskInfo">
                    <div class="taskIcon">
                       <% if (task.category === 'pet') { %>
                          <%- include('../tasks/icons/pet') %>
                        <% } else if (task.category === 'cleaning') { %>
                          <%- include('../tasks/icons/cleaning') %>
                        <% } else if (task.category === 'garage') { %>
                          <%- include('../tasks/icons/garage') %>
                        <% } else if (task.category === 'garden') { %>
                          <%- include('../tasks/icons/garden') %>
                          <% } else if (task.category === 'misc') { %>
                            <%- include('../tasks/icons/misc') %>
                          <% } %>
                    </div>
                    <div class="taskText">
                      <h3><%= task.title %></h3>
                      <small class="dueDate" data-due="<%= task.dueDate.toISOString ? task.dueDate.toISOString() : task.dueDate %>">$<%= task.reward ? task.reward.toFixed(2) : '0.00' %> | <%= task.formattedDue %></small>
                    </div>
                  </div>
                  <div class="taskStatus">
                    <span class="statusBadge <%= task.status %>">
                      <%= task.status ? task.status.charAt(0).toUpperCase() + task.status.slice(1).replace('_', ' ') : 'New' %>
                    </span>
                  </div>
                </div>
              <% }); %>
            </div>
          <% } else { %>
            <div class="noTasksMessage">
              <h1>No Tasks Yet</h1>
              <p>Ask your parent to assign a task.</p>
            </div>
          <% } %>
        </div>

<div class="learningContainer">
  <% if (learningProgress && learningProgress.length > 0) { %>
    <div class="sectionTabs">
      <h2>Learning</h2>
      <h2>Status</h2>
    </div>
    <div class="learningList">
      <% learningProgress.forEach(function(module) { %>
        <a href="/learn/view/<%= module._id %>" class="learningCardLink">
          <div class="learningCard">
            <div class="learningInfo">
              <div class="learningIcon">
                <i class="fa-solid fa-book-open-reader"></i>
              </div>
              <div class="learningText">
                <h3><%= module.title %></h3>
                <p><%= module.category || 'Financial Education' %></p>
                <% if (user.accountType === 'parent' && !viewingAsChild && module.childName) { %>
                  <small>Assigned to: <%= module.childName %></small>
                <% } %>
              </div>
            </div>
            <div class="taskStatus">
              <% if (module.completed) { %>
                <span class="statusBadge completed"><i class="fa-solid fa-check"></i> Complete</span>
              <% } else if (module.status === 'to do') { %>
                <span class="statusBadge todo">To Do</span>
              <% } else { %>
                <span class="statusBadge new">New</span>
              <% } %>
            </div>
          </div>
        </a>
      <% }); %>
    </div>
  <% } else { %>
    <div class="noLearningMessage">
      <h2>Learning</h2>
      <h3>No Learning Modules</h3>
      <p>Check back soon for new learning content!</p>
    </div>
  <% } %>
</div>
      
      <%- include('../partials/bottomNav') %>
    </main>
  </div>
  <script src="/dynamic/formatDueDates.js"></script>
</body>
</html>