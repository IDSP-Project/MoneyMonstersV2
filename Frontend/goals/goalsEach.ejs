<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Goal Details - Money Monsters</title>
  <link rel="stylesheet" href="/style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body data-goal-id="<%= goal._id %>">
  <div class="container">
    <header>
      <%- include('../partials/header') %>
    </header>
    <main>
      <div class="goal-details-page">
        <% if (error) { %>
          <div class="error-message"><%= error %></div>
        <% } else if (goal) { %>
          <div class="progress-container">
            <div class="progressBar">
              <svg width="280" height="154" viewBox="0 0 280 154" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M266 139.091C266 122.675 262.741 106.421 256.409 91.2556C250.077 76.09 240.796 62.31 229.095 50.7028C217.395 39.0954 203.505 29.888 188.218 23.6061C172.931 17.3243 156.547 14.0911 140 14.0911C123.453 14.0911 107.069 17.3243 91.782 23.606C76.4949 29.8879 62.6048 39.0953 50.9046 50.7027C39.2044 62.31 29.9233 76.0899 23.5912 91.2555C17.2591 106.421 14 122.675 14 139.091" stroke="#E0E0E0" stroke-width="28" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M14 139.091C14 112.698 22.4242 86.9834 38.0655 65.6296C53.707 44.276 75.7629 28.3795 101.073 20.2179C126.384 12.0564 153.65 12.0486 178.965 20.1955C204.281 28.3424 226.345 44.2262 242 65.5708" stroke="#7F56D9" stroke-width="28" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <div class="progress-text">
              <span class="progress-percentage">80%</span>
              <span class="progress-label">Completed</span>
            </div>
          </div>

          <div class="goal-details-card">
            <% if (goal.purchaseLink) { %>
              <img src="/images/goal.png" alt="Goal Image" class="goal-image" />
            <% } else { %>
              <div class="initials-avatar"><%= goal.title ? goal.title.split(' ').map(w => w[0]).join('').toUpperCase().slice(0,2) : '' %></div>
            <% } %>
            <div>
              <h2 class="goal-title"><%= goal.title %></h2>
              <p class="goal-source"><%= goal.purchaseLink ? new URL(goal.purchaseLink).hostname : 'Custom Goal' %></p>
              <% if (goal.description && goal.description.trim() !== '' && goal.description !== 'Custom goal') { %>
                <p class="goal-description"><%= goal.description %></p>
              <% } else { %>
                <p class="goal-description missing">No Description Added</p>
              <% } %>
              <div class="goal-price">Target: $<%= goal.price ? goal.price.toFixed(2) : '0.00' %></div>
            </div>
          </div>
          <div class="tasks-container">
            <div class="section-tabs">
              <span class="tab tasks-tab">Tasks</span>
              <span class="tab status-tab">Status</span>
            </div>
            <div class="assign-task-container">
              <button class="assign-task-btn" onclick="openAssignTaskModal()">
                <i class="fas fa-plus"></i> Assign Task
              </button>
            </div>
            <% if (assignedTasks && assignedTasks.length > 0) { %>
              <div class="task-list">
                <% assignedTasks.forEach(function(task) { %>
                  <% let iconClass = 'fa-solid '; %>
                  <% switch(task.category) {
                    case 'pet': iconClass += 'fa-dog'; break;
                    case 'cleaning': iconClass += 'fa-broom'; break;
                    case 'garage': iconClass += 'fa-warehouse'; break;
                    case 'garden': iconClass += 'fa-leaf'; break;
                    case 'misc': iconClass += 'fa-circle-check'; break;
                    default: iconClass += 'fa-list-check';
                  } %>
                  <div class="task-card" data-description="<%= task.description ? task.description.split('"').join('&quot;') : '' %>" data-task-id="<%= task._id %>" data-goal-id="<%= task.goalId ? task.goalId : '' %>">
                    <div class="task-info">
                      <i class="<%= iconClass %> task-icon"></i>
                      <div class="task-text">
                        <h3><%= task.title %></h3>
                        <small class="due-date" data-due="<%= task.dueDate && task.dueDate.toISOString ? task.dueDate.toISOString() : task.dueDate %>">$<%= task.reward ? task.reward.toFixed(2) : '0.00' %> |<%= task.formattedDue ? task.formattedDue : '' %></small>
                      </div>
                    </div>
                    <div class="task-status">
                      <span class="status-badge <%= task.status %>">
                        <%= task.status ? task.status.charAt(0).toUpperCase() + task.status.slice(1).replace('_', ' ') : 'New' %>
                      </span>
                    </div>
                  </div>
                <% }); %>
              </div>
            <% } else { %>
              <div class="no-tasks-message">
                <i class="fas fa-tasks"></i>
                <h2>No Tasks Yet</h2>
                <p>There are no tasks assigned to this goal yet. You can assign tasks to your goal by clicking the "Assign Task" button.</p>
              </div>
            <% } %>
          </div>
        <% } %>
      </div>
    </main>
    <footer>
      <%- include('../partials/bottomNav', { user: user, currentPage: 'goals' }) %>
    </footer>
  </div>
  <script src="/dynamic/formatDueDates.js"></script>
  <script src="/dynamic/goalDetails.js"></script>
  <script src="/dynamic/progressBar.js"></script>


  <!-- Assign Task Modal -->
  <div id="assignTaskModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Assign Task to Goal</h2>
        <span class="close" onclick="closeAssignTaskModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div class="task-list">
          <!-- Tasks will be loaded here dynamically -->
        </div>
      </div>
    </div>
  </div>
</body>
</html>